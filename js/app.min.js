"use strict";(()=>{const e=document.querySelector("#placement__img-map-wrapper-js"),t=()=>{const e=new google.maps.Map(document.getElementById("map"),{zoom:17,center:{lat:59.93899,lng:30.32145}});new google.maps.Marker({position:{lat:59.938628,lng:30.3238},map:e,icon:"img/map-marker.png"})};if(e){const n=document.createElement("div");n.setAttribute("id","map"),n.setAttribute("class","placement__map"),e.parentElement.replaceChild(n,e);const i=document.createElement("script");i.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDdxiZ8JD-Awc3VOchAbkcA54-XHZJYkGY&callback=initMap",i.defer=!0,window.initMap=t,document.head.appendChild(i)}})(),(()=>{const e="ArrowLeft",t="ArrowRight",n=document.querySelector("#filter-panel__cost-title-js"),i=document.querySelector("#cost-min-js"),r=document.querySelector("#cost-max-js");if(n&&i&&r){const o=(e=>{const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild})('\n      <div class="filter-panel__cost-range">\n        <div class="filter-panel__cost-range-line">\n          <div\n            class="filter-panel__cost-point filter-panel__cost-point--min"\n            tabindex="0"\n            id="filter-panel__cost-point-min-js"\n            aria-label="Изменить минимальную стоимость"\n          ></div>\n          <div\n            class="filter-panel__cost-point filter-panel__cost-point--max"\n            tabindex="0"\n            id="filter-panel__cost-point-max-js"\n            aria-label="Изменить максимальную стоимость"\n          ></div>\n        </div>\n      </div>\n    '),s=o.querySelector(".filter-panel__cost-range-line"),l=o.querySelector("#filter-panel__cost-point-min-js"),a=o.querySelector("#filter-panel__cost-point-max-js"),c={MIN:{propName:"--min-percent",limitCostValue:0,limitPropValue:0,initPropValue:0,input:i,point:l},MAX:{propName:"--max-percent",limitCostValue:22059,limitPropValue:100,initPropValue:68,input:r,point:a}},p=e=>parseFloat(o.style.getPropertyValue(e.propName).split("%")[0]),u=e=>{const t=parseInt(e.input.value,10);return Number.isNaN(t)?e.limitPropValue:t/c.MAX.limitCostValue*c.MAX.limitPropValue},d=e=>{const t=p(e);return Math.round(c.MAX.limitCostValue*t/c.MAX.limitPropValue)},m=e=>{const t=d(e);parseFloat(e.input.value)!==t&&(e.input.value=t)},v=(e,t)=>{o.style.setProperty(e.propName,t+"%"),m(e)},_=(e,t)=>{(t=t||u(e))<c.MIN.limitPropValue?t=c.MIN.limitPropValue:t>c.MAX.limitPropValue&&(t=c.MAX.limitPropValue),e===c.MIN&&t>p(c.MAX)?v(c.MAX,t):e===c.MAX&&t<p(c.MIN)&&v(c.MIN,t),v(e,t)},L=e=>{e.target===c.MIN.input?_(c.MIN):_(c.MAX)},E=e=>{const t=e.target===c.MIN.point?c.MIN:c.MAX,n=s.clientWidth,i=s.getBoundingClientRect().left,r=e=>{const r=Math.round((e.x-i)/n*100);_(t,r)},o=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",o)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",o)},y=n=>{const i=n.target===c.MIN.point?c.MIN:c.MAX;n.code===e?_(i,p(i)-1):n.code===t&&_(i,p(i)+1)};v(c.MIN,c.MIN.initPropValue),v(c.MAX,c.MAX.initPropValue),i.addEventListener("input",L),r.addEventListener("input",L),l.addEventListener("mousedown",E),a.addEventListener("mousedown",E),l.addEventListener("keydown",y),a.addEventListener("keydown",y),n.after(o)}})(),(()=>{const e="popup--opened",t="popup--error",n=document.querySelector("#placement__description-button-js"),i=document.querySelector("#popup-js"),r=i.querySelector("#popup__form-js"),o=i.querySelector("#popup__close-button-js"),s=i.querySelector("#popup__submit-js"),l=i.querySelector("#popup-field-name-js"),a=i.querySelector("#popup-field-email-js"),c=i.querySelector("#popup-field-letter-js"),p={NAME:"userName",EMAIL:"userEmail"},u=e=>{"Escape"===e.code&&m()},d=t=>{t.preventDefault(),i.classList.add(e),l.value=localStorage.getItem(p.NAME),a.value=localStorage.getItem(p.EMAIL),o.addEventListener("click",m),s.addEventListener("click",v),l.addEventListener("input",E),a.addEventListener("input",E),c.addEventListener("input",E),document.addEventListener("keydown",u),l.focus()},m=r=>{r&&r.preventDefault(),i.classList.remove(e),i.classList.remove(t),o.removeEventListener("click",m),s.removeEventListener("click",v),l.removeEventListener("input",E),a.removeEventListener("input",E),c.removeEventListener("input",E),document.removeEventListener("keydown",u),n.focus()},v=e=>{e.preventDefault(),i.classList.remove(t),L()&&fetch("https://echo.htmlacademy.ru/",{method:"POST",body:new FormData(r)}).then((e=>{if(!e.ok)throw i.classList.add(t),new Error(`_${e.status}: ${e.statusText}`);return localStorage.setItem(p.NAME,l.value),localStorage.setItem(p.EMAIL,a.value),l.value="",a.value="",c.value="",m(),e})).catch((e=>{throw i.classList.add(t),e}))},_=e=>e.value.length>0?(e.setCustomValidity(""),!0):(e.setCustomValidity("Обязательное поле для заполнения"),!1),L=()=>_(l)&&_(a)&&_(c),E=e=>{_(e.target)};i&&n&&o&&s&&(i.classList.remove("popup--no-js"),n.addEventListener("click",d))})(),(()=>{const e=document.querySelector(".principles");if(e){const t="principles__slide--active",n="principles__control-button--active",i=e=>{const t=document.createElement("div");return t.innerHTML=e,t.firstChild},r=(r,o)=>{const s=i(`<li>\n          <button class="principles__control-button  ${o?"":n}" type="button">\n            <span class="visually-hidden">Принцип ${o+1}</span>\n          </button>\n        </li>`);return s.firstElementChild.addEventListener("click",(i=>{const o=e.querySelector("."+t);o!==r&&(e.querySelector("."+n).classList.remove(n),o.classList.remove(t),r.classList.add(t),i.target.classList.add(n))})),o||r.classList.add(t),s},o=e.querySelector("#principles__slider-js"),s=e.querySelectorAll(".principles__slide"),l=i('<ul class="principles__control list-reset"></ul>');s.forEach(((e,t)=>{e.classList.remove("principles__slide--no-js"),l.append(r(e,t))})),o.after(l)}})(),(()=>{const e=Array.from(document.querySelectorAll(".sort-panel__type")),t=Array.from(document.querySelectorAll(".sort-panel__direction")),n=n=>{const i=n.target;let r="",o=[];e.includes(i)?(r="sort-panel__type--active",o=e):(r="sort-panel__direction--active",o=t),o.filter((e=>e.classList.contains(r))).forEach((e=>e.classList.remove(r))),i.classList.add(r)};e.forEach((e=>e.addEventListener("click",n))),t.forEach((e=>e.addEventListener("click",n)))})();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hcC5qcyIsIm11bHRpcGxlLXJhbmdlLmpzIiwicG9wdXAuanMiLCJzbGlkZXIuanMiLCJzb3J0LmpzIl0sIm5hbWVzIjpbIm1hcEltZ1dyYXBwZXIiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3IiLCJpbml0TWFwIiwibWFwIiwiZ29vZ2xlIiwibWFwcyIsIk1hcCIsImdldEVsZW1lbnRCeUlkIiwiem9vbSIsImNlbnRlciIsImxhdCIsImxuZyIsIk1hcmtlciIsInBvc2l0aW9uIiwiaWNvbiIsIm1hcENvbnRhaW5lciIsImNyZWF0ZUVsZW1lbnQiLCJzZXRBdHRyaWJ1dGUiLCJwYXJlbnRFbGVtZW50IiwicmVwbGFjZUNoaWxkIiwic2NyaXB0Iiwic3JjIiwiZGVmZXIiLCJ3aW5kb3ciLCJoZWFkIiwiYXBwZW5kQ2hpbGQiLCJLZXlDb2RlIiwicHJldkVsZW1lbnQiLCJtaW5Db3N0IiwibWF4Q29zdCIsInJhbmdlQmxvY2siLCJ0ZW1wbGF0ZSIsIndyYXBwZXIiLCJpbm5lckhUTUwiLCJmaXJzdEVsZW1lbnRDaGlsZCIsInJhbmdlTGluZSIsInBvaW50TWluIiwicG9pbnRNYXgiLCJDb3N0T2JqIiwiTUlOIiwicHJvcE5hbWUiLCJsaW1pdENvc3RWYWx1ZSIsImxpbWl0UHJvcFZhbHVlIiwiaW5pdFByb3BWYWx1ZSIsImlucHV0IiwicG9pbnQiLCJNQVgiLCJnZXRDdXJyZW50UHJvcFZhbHVlIiwiY29zdE9iaiIsInBhcnNlRmxvYXQiLCJzdHlsZSIsImdldFByb3BlcnR5VmFsdWUiLCJzcGxpdCIsImNhbGN1bGF0ZVByb3BWYWx1ZSIsIm5ld0Nvc3RWYWx1ZSIsInBhcnNlSW50IiwidmFsdWUiLCJOdW1iZXIiLCJpc05hTiIsImNhbGN1bGF0ZUNvc3RWYWx1ZSIsImN1cnJlbnRQcm9wVmFsdWUiLCJNYXRoIiwicm91bmQiLCJjaGFuZ2VDb3N0VmFsdWUiLCJtYWtlU3luY2hyb25pemF0aW9uIiwibmV3UHJvcFZhbHVlIiwic2V0UHJvcGVydHkiLCJjaGFuZ2VQcm9wVmFsdWUiLCJvbkNoYW5nZUNvc3RWYWx1ZSIsImV2dCIsInRhcmdldCIsIm9uUG9pbnRNb3VzZURvd24iLCJkb3duRXZ0IiwibGluZVdpZHRoIiwiY2xpZW50V2lkdGgiLCJsZWZ0T2Zmc2V0IiwiZ2V0Qm91bmRpbmdDbGllbnRSZWN0IiwibGVmdCIsIm9uTW92ZVBvaW50IiwibW91c2VFdnQiLCJ4Iiwib25VcFBvaW50IiwicmVtb3ZlRXZlbnRMaXN0ZW5lciIsImFkZEV2ZW50TGlzdGVuZXIiLCJvblBvaW50S2V5RG93biIsImtleURvd25FdnQiLCJjb2RlIiwiYWZ0ZXIiLCJPUEVORURfQ0xBU1MiLCJFUlJPUl9DTEFTUyIsIm9wZW5Qb3B1cEJ0biIsInBvcHVwIiwicG9wdXBGb3JtIiwiY2xvc2VQb3B1cEJ0biIsInN1Ym1pdFBvcHVwRm9ybUJ0biIsIm5hbWVJbnB1dCIsImVtYWlsSW5wdXQiLCJsZXR0ZXJUZXh0YXJlYSIsIkxvY2FsU3RvcmFnZUtleSIsIk5BTUUiLCJFTUFJTCIsIm9uRXNjS2V5RG93biIsImNsb3NlUG9wdXAiLCJvcGVuUG9wdXAiLCJwcmV2ZW50RGVmYXVsdCIsImNsYXNzTGlzdCIsImFkZCIsImxvY2FsU3RvcmFnZSIsImdldEl0ZW0iLCJzdWJtaXRGb3JtIiwib25GaWVsZERhdGFDaGFuZ2VkIiwiZm9jdXMiLCJyZW1vdmUiLCJpc1ZhbGlkRm9ybURhdGEiLCJmZXRjaCIsIm1ldGhvZCIsImJvZHkiLCJGb3JtRGF0YSIsInRoZW4iLCJyZXNwb25zZSIsIm9rIiwiRXJyb3IiLCJzdGF0dXMiLCJzdGF0dXNUZXh0Iiwic2V0SXRlbSIsImNhdGNoIiwiZXJyb3IiLCJpc1ZhbGlkRmllbGQiLCJmaWVsZCIsImxlbmd0aCIsInNldEN1c3RvbVZhbGlkaXR5Iiwic2xpZGVyQ29udGFpbmVyIiwiU0xJREVfQUNUSVZFX0NMQVNTIiwiQlVUVE9OX0FDVElWRV9DTEFTUyIsIm5ld0VsZW1lbnQiLCJmaXJzdENoaWxkIiwiY3JlYXRlU2xpZGVyQnV0dG9uIiwic2xpZGUiLCJudW1iZXIiLCJidXR0b25XcmFwcGVyIiwiY3VycmVudFNsaWRlIiwiYmVmb3JlSW5zZXJ0QmxvY2siLCJzbGlkZXMiLCJxdWVyeVNlbGVjdG9yQWxsIiwiYnV0dG9uc0NvbnRhaW5lciIsImZvckVhY2giLCJpbmRleCIsImFwcGVuZCIsInNvcnRUeXBlQnV0dG9ucyIsIkFycmF5IiwiZnJvbSIsInNvcnREaXJlY3Rpb25CdXR0b25zIiwib25CdG5DbGljayIsInNlbGVjdGVkQnRuIiwiYWN0aXZlQ2xhc3MiLCJidG5zIiwiaW5jbHVkZXMiLCJmaWx0ZXIiLCJidG4iLCJjb250YWlucyJdLCJtYXBwaW5ncyI6IkFBQUEsYUFFQSxNQUNBLE1BQUFBLEVBQUFDLFNBQUFDLGNBQUEsa0NBRUFDLEVBQUEsS0FFQSxNQUFBQyxFQUFBLElBQUFDLE9BQUFDLEtBQUFDLElBQUFOLFNBQUFPLGVBQUEsT0FBQSxDQUNBQyxLQUFBLEdBQ0FDLE9BQUEsQ0FDQUMsSUFBQSxTQUNBQyxJQUFBLFlBS0EsSUFBQVAsT0FBQUMsS0FBQU8sT0FBQSxDQUNBQyxTQUFBLENBQ0FILElBQUEsVUFDQUMsSUFBQSxTQUVBUixJQUFBQSxFQUNBVyxLQUFBLHdCQUlBLEdBQUFmLEVBQUEsQ0FDQSxNQUFBZ0IsRUFBQWYsU0FBQWdCLGNBQUEsT0FDQUQsRUFBQUUsYUFBQSxLQUFBLE9BQ0FGLEVBQUFFLGFBQUEsUUFBQSxrQkFDQWxCLEVBQUFtQixjQUFBQyxhQUFBSixFQUFBaEIsR0FFQSxNQUFBcUIsRUFBQXBCLFNBQUFnQixjQUFBLFVBQ0FJLEVBQUFDLElBQUEsdUdBQ0FELEVBQUFFLE9BQUEsRUFFQUMsT0FBQXJCLFFBQUFBLEVBRUFGLFNBQUF3QixLQUFBQyxZQUFBTCxLQXBDQSxHQ0FBLE1BQ0EsTUFBQU0sRUFDQSxZQURBQSxFQUVBLGFBR0FDLEVBQUEzQixTQUFBQyxjQUFBLGdDQUNBMkIsRUFBQTVCLFNBQUFDLGNBQUEsZ0JBQ0E0QixFQUFBN0IsU0FBQUMsY0FBQSxnQkFTQSxHQUFBMEIsR0FBQUMsR0FBQUMs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VUFBQU8sT0FBQTBDLEtBRUFELEVBQUFoRCxVQUFBQyxJQUFBZ0QsSUFHQU4sRUFBQUgsU0FBQWEsR0FBQUEsRUFBQTNFLGlCQUFBLFFBQUFxRSxLQUNBRCxFQUFBTixTQUFBYSxHQUFBQSxFQUFBM0UsaUJBQUEsUUFBQXFFLE1BNUJBIiwiZmlsZSI6ImFwcC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbigoKSA9PiB7XG4gIGNvbnN0IG1hcEltZ1dyYXBwZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjcGxhY2VtZW50X19pbWctbWFwLXdyYXBwZXItanNgKTtcblxuICBjb25zdCBpbml0TWFwID0gKCkgPT4ge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bmRlZlxuICAgIGNvbnN0IG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYG1hcGApLCB7XG4gICAgICB6b29tOiAxNyxcbiAgICAgIGNlbnRlcjoge1xuICAgICAgICBsYXQ6IDU5LjkzODk5MCxcbiAgICAgICAgbG5nOiAzMC4zMjE0NTAsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVmLCBuby11bnVzZWQtdmFyc1xuICAgIGNvbnN0IG1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xuICAgICAgcG9zaXRpb246IHtcbiAgICAgICAgbGF0OiA1OS45Mzg2MjgsXG4gICAgICAgIGxuZzogMzAuMzIzODAwLFxuICAgICAgfSxcbiAgICAgIG1hcCxcbiAgICAgIGljb246IGBpbWcvbWFwLW1hcmtlci5wbmdgLFxuICAgIH0pO1xuICB9O1xuXG4gIGlmIChtYXBJbWdXcmFwcGVyKSB7XG4gICAgY29uc3QgbWFwQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChgZGl2YCk7XG4gICAgbWFwQ29udGFpbmVyLnNldEF0dHJpYnV0ZShgaWRgLCBgbWFwYCk7XG4gICAgbWFwQ29udGFpbmVyLnNldEF0dHJpYnV0ZShgY2xhc3NgLCBgcGxhY2VtZW50X19tYXBgKTtcbiAgICBtYXBJbWdXcmFwcGVyLnBhcmVudEVsZW1lbnQucmVwbGFjZUNoaWxkKG1hcENvbnRhaW5lciwgbWFwSW1nV3JhcHBlcik7XG5cbiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGBzY3JpcHRgKTtcbiAgICBzY3JpcHQuc3JjID0gYGh0dHBzOi8vbWFwcy5nb29nbGVhcGlzLmNvbS9tYXBzL2FwaS9qcz9rZXk9QUl6YVN5RGR4aVo4SkQtQXdjM1ZPY2hBYmtjQTU0LVhIWkpZa0dZJmNhbGxiYWNrPWluaXRNYXBgO1xuICAgIHNjcmlwdC5kZWZlciA9IHRydWU7XG5cbiAgICB3aW5kb3cuaW5pdE1hcCA9IGluaXRNYXA7XG5cbiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7XG4gIH1cbn0pKCk7XG4iLCIndXNlIHN0cmljdCc7XG5cbigoKSA9PiB7XG4gIGNvbnN0IEtleUNvZGUgPSB7XG4gICAgbGVmdDogYEFycm93TGVmdGAsXG4gICAgcmlnaHQ6IGBBcnJvd1JpZ2h0YCxcbiAgfTtcblxuICBjb25zdCBwcmV2RWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYCNmaWx0ZXItcGFuZWxfX2Nvc3QtdGl0bGUtanNgKTtcbiAgY29uc3QgbWluQ29zdCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYCNjb3N0LW1pbi1qc2ApO1xuICBjb25zdCBtYXhDb3N0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgI2Nvc3QtbWF4LWpzYCk7XG5cbiAgY29uc3QgY3JlYXRlRWxlbWVudCA9ICh0ZW1wbGF0ZSkgPT4ge1xuICAgIGNvbnN0IHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGBkaXZgKTtcbiAgICB3cmFwcGVyLmlubmVySFRNTCA9IHRlbXBsYXRlO1xuXG4gICAgcmV0dXJuIHdyYXBwZXIuZmlyc3RFbGVtZW50Q2hpbGQ7XG4gIH07XG5cbiAgaWYgKHByZXZFbGVtZW50ICYmIG1pbkNvc3QgJiYgbWF4Q29zdCkge1xuICAgIGNvbnN0IG1hcmt1cCA9IChgXG4gICAgICA8ZGl2IGNsYXNzPVwiZmlsdGVyLXBhbmVsX19jb3N0LXJhbmdlXCI+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJmaWx0ZXItcGFuZWxfX2Nvc3QtcmFuZ2UtbGluZVwiPlxuICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgIGNsYXNzPVwiZmlsdGVyLXBhbmVsX19jb3N0LXBvaW50IGZpbHRlci1wYW5lbF9fY29zdC1wb2ludC0tbWluXCJcbiAgICAgICAgICAgIHRhYmluZGV4PVwiMFwiXG4gICAgICAgICAgICBpZD1cImZpbHRlci1wYW5lbF9fY29zdC1wb2ludC1taW4tanNcIlxuICAgICAgICAgICAgYXJpYS1sYWJlbD1cItCY0LfQvNC10L3QuNGC0Ywg0LzQuNC90LjQvNCw0LvRjNC90YPRjiDRgdGC0L7QuNC80L7RgdGC0YxcIlxuICAgICAgICAgID48L2Rpdj5cbiAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICBjbGFzcz1cImZpbHRlci1wYW5lbF9fY29zdC1wb2ludCBmaWx0ZXItcGFuZWxfX2Nvc3QtcG9pbnQtLW1heFwiXG4gICAgICAgICAgICB0YWJpbmRleD1cIjBcIlxuICAgICAgICAgICAgaWQ9XCJmaWx0ZXItcGFuZWxfX2Nvc3QtcG9pbnQtbWF4LWpzXCJcbiAgICAgICAgICAgIGFyaWEtbGFiZWw9XCLQmNC30LzQtdC90LjRgtGMINC80LDQutGB0LjQvNCw0LvRjNC90YPRjiDRgdGC0L7QuNC80L7RgdGC0YxcIlxuICAgICAgICAgID48L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICBgKTtcblxuICAgIGNvbnN0IHJhbmdlQmxvY2sgPSBjcmVhdGVFbGVtZW50KG1hcmt1cCk7XG4gICAgY29uc3QgcmFuZ2VMaW5lID0gcmFuZ2VCbG9jay5xdWVyeVNlbGVjdG9yKGAuZmlsdGVyLXBhbmVsX19jb3N0LXJhbmdlLWxpbmVgKTtcbiAgICBjb25zdCBwb2ludE1pbiA9IHJhbmdlQmxvY2sucXVlcnlTZWxlY3RvcihgI2ZpbHRlci1wYW5lbF9fY29zdC1wb2ludC1taW4tanNgKTtcbiAgICBjb25zdCBwb2ludE1heCA9IHJhbmdlQmxvY2sucXVlcnlTZWxlY3RvcihgI2ZpbHRlci1wYW5lbF9fY29zdC1wb2ludC1tYXgtanNgKTtcblxuICAgIGNvbnN0IENvc3RPYmogPSB7XG4gICAgICBNSU46IHtcbiAgICAgICAgcHJvcE5hbWU6IGAtLW1pbi1wZXJjZW50YCxcbiAgICAgICAgbGltaXRDb3N0VmFsdWU6IDAsXG4gICAgICAgIGxpbWl0UHJvcFZhbHVlOiAwLFxuICAgICAgICBpbml0UHJvcFZhbHVlOiAwLFxuICAgICAgICBpbnB1dDogbWluQ29zdCxcbiAgICAgICAgcG9pbnQ6IHBvaW50TWluLFxuICAgICAgfSxcbiAgICAgIE1BWDoge1xuICAgICAgICBwcm9wTmFtZTogYC0tbWF4LXBlcmNlbnRgLFxuICAgICAgICBsaW1pdENvc3RWYWx1ZTogMjIwNTksXG4gICAgICAgIGxpbWl0UHJvcFZhbHVlOiAxMDAsXG4gICAgICAgIGluaXRQcm9wVmFsdWU6IDY4LFxuICAgICAgICBpbnB1dDogbWF4Q29zdCxcbiAgICAgICAgcG9pbnQ6IHBvaW50TWF4LFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgY29uc3QgZ2V0Q3VycmVudFByb3BWYWx1ZSA9IChjb3N0T2JqKSA9PiB7XG4gICAgICByZXR1cm4gcGFyc2VGbG9hdChcbiAgICAgICAgICByYW5nZUJsb2NrLnN0eWxlLmdldFByb3BlcnR5VmFsdWUoY29zdE9iai5wcm9wTmFtZSkuc3BsaXQoYCVgKVswXVxuICAgICAgKTtcbiAgICB9O1xuXG4gICAgY29uc3QgY2FsY3VsYXRlUHJvcFZhbHVlID0gKGNvc3RPYmopID0+IHtcbiAgICAgIGNvbnN0IG5ld0Nvc3RWYWx1ZSA9IHBhcnNlSW50KGNvc3RPYmouaW5wdXQudmFsdWUsIDEwKTtcblxuICAgICAgaWYgKE51bWJlci5pc05hTihuZXdDb3N0VmFsdWUpKSB7XG4gICAgICAgIHJldHVybiBjb3N0T2JqLmxpbWl0UHJvcFZhbHVlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbmV3Q29zdFZhbHVlIC8gQ29zdE9iai5NQVgubGltaXRDb3N0VmFsdWUgKiBDb3N0T2JqLk1BWC5saW1pdFByb3BWYWx1ZTtcbiAgICB9O1xuXG4gICAgY29uc3QgY2FsY3VsYXRlQ29zdFZhbHVlID0gKGNvc3RPYmopID0+IHtcbiAgICAgIGNvbnN0IGN1cnJlbnRQcm9wVmFsdWUgPSBnZXRDdXJyZW50UHJvcFZhbHVlKGNvc3RPYmopO1xuXG4gICAgICByZXR1cm4gTWF0aC5yb3VuZChcbiAgICAgICAgICBDb3N0T2JqLk1BWC5saW1pdENvc3RWYWx1ZSAqIGN1cnJlbnRQcm9wVmFsdWUgLyBDb3N0T2JqLk1BWC5saW1pdFByb3BWYWx1ZVxuICAgICAgKTtcbiAgICB9O1xuXG4gICAgY29uc3QgY2hhbmdlQ29zdFZhbHVlID0gKGNvc3RPYmopID0+IHtcbiAgICAgIGNvbnN0IG5ld0Nvc3RWYWx1ZSA9IGNhbGN1bGF0ZUNvc3RWYWx1ZShjb3N0T2JqKTtcblxuICAgICAgaWYgKHBhcnNlRmxvYXQoY29zdE9iai5pbnB1dC52YWx1ZSkgIT09IG5ld0Nvc3RWYWx1ZSkge1xuICAgICAgICBjb3N0T2JqLmlucHV0LnZhbHVlID0gbmV3Q29zdFZhbHVlO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCBtYWtlU3luY2hyb25pemF0aW9uID0gKGNvc3RPYmosIG5ld1Byb3BWYWx1ZSkgPT4ge1xuICAgICAgcmFuZ2VCbG9jay5zdHlsZS5zZXRQcm9wZXJ0eShjb3N0T2JqLnByb3BOYW1lLCBgJHtuZXdQcm9wVmFsdWV9JWApO1xuICAgICAgY2hhbmdlQ29zdFZhbHVlKGNvc3RPYmopO1xuICAgIH07XG5cbiAgICBjb25zdCBjaGFuZ2VQcm9wVmFsdWUgPSAoY29zdE9iaiwgbmV3UHJvcFZhbHVlKSA9PiB7XG4gICAgICBuZXdQcm9wVmFsdWUgPSBuZXdQcm9wVmFsdWUgPyBuZXdQcm9wVmFsdWUgOiBjYWxjdWxhdGVQcm9wVmFsdWUoY29zdE9iaik7XG5cbiAgICAgIGlmIChuZXdQcm9wVmFsdWUgPCBDb3N0T2JqLk1JTi5saW1pdFByb3BWYWx1ZSkge1xuICAgICAgICBuZXdQcm9wVmFsdWUgPSBDb3N0T2JqLk1JTi5saW1pdFByb3BWYWx1ZTtcbiAgICAgIH0gZWxzZSBpZiAobmV3UHJvcFZhbHVlID4gQ29zdE9iai5NQVgubGltaXRQcm9wVmFsdWUpIHtcbiAgICAgICAgbmV3UHJvcFZhbHVlID0gQ29zdE9iai5NQVgubGltaXRQcm9wVmFsdWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChjb3N0T2JqID09PSBDb3N0T2JqLk1JTiAmJiBuZXdQcm9wVmFsdWUgPiBnZXRDdXJyZW50UHJvcFZhbHVlKENvc3RPYmouTUFYKSkge1xuICAgICAgICBtYWtlU3luY2hyb25pemF0aW9uKENvc3RPYmouTUFYLCBuZXdQcm9wVmFsdWUpO1xuICAgICAgfSBlbHNlIGlmIChjb3N0T2JqID09PSBDb3N0T2JqLk1BWCAmJiBuZXdQcm9wVmFsdWUgPCBnZXRDdXJyZW50UHJvcFZhbHVlKENvc3RPYmouTUlOKSkge1xuICAgICAgICBtYWtlU3luY2hyb25pemF0aW9uKENvc3RPYmouTUlOLCBuZXdQcm9wVmFsdWUpO1xuICAgICAgfVxuXG4gICAgICBtYWtlU3luY2hyb25pemF0aW9uKGNvc3RPYmosIG5ld1Byb3BWYWx1ZSk7XG4gICAgfTtcblxuICAgIGNvbnN0IG9uQ2hhbmdlQ29zdFZhbHVlID0gKGV2dCkgPT4ge1xuICAgICAgaWYgKGV2dC50YXJnZXQgPT09IENvc3RPYmouTUlOLmlucHV0KSB7XG4gICAgICAgIGNoYW5nZVByb3BWYWx1ZShDb3N0T2JqLk1JTik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjaGFuZ2VQcm9wVmFsdWUoQ29zdE9iai5NQVgpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCBvblBvaW50TW91c2VEb3duID0gKGRvd25FdnQpID0+IHtcbiAgICAgIGNvbnN0IGNvc3RPYmogPSBkb3duRXZ0LnRhcmdldCA9PT0gQ29zdE9iai5NSU4ucG9pbnRcbiAgICAgICAgPyBDb3N0T2JqLk1JTlxuICAgICAgICA6IENvc3RPYmouTUFYO1xuICAgICAgY29uc3QgbGluZVdpZHRoID0gcmFuZ2VMaW5lLmNsaWVudFdpZHRoO1xuICAgICAgY29uc3QgbGVmdE9mZnNldCA9IHJhbmdlTGluZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0O1xuXG4gICAgICBjb25zdCBvbk1vdmVQb2ludCA9IChtb3VzZUV2dCkgPT4ge1xuICAgICAgICBjb25zdCBuZXdQcm9wVmFsdWUgPSBNYXRoLnJvdW5kKChtb3VzZUV2dC54IC0gbGVmdE9mZnNldCkgLyBsaW5lV2lkdGggKiAxMDApO1xuXG4gICAgICAgIGNoYW5nZVByb3BWYWx1ZShjb3N0T2JqLCBuZXdQcm9wVmFsdWUpO1xuICAgICAgfTtcblxuICAgICAgY29uc3Qgb25VcFBvaW50ID0gKCkgPT4ge1xuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKGBtb3VzZW1vdmVgLCBvbk1vdmVQb2ludCk7XG4gICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoYG1vdXNldXBgLCBvblVwUG9pbnQpO1xuICAgICAgfTtcblxuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihgbW91c2Vtb3ZlYCwgb25Nb3ZlUG9pbnQpO1xuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihgbW91c2V1cGAsIG9uVXBQb2ludCk7XG4gICAgfTtcblxuICAgIGNvbnN0IG9uUG9pbnRLZXlEb3duID0gKGtleURvd25FdnQpID0+IHtcbiAgICAgIGNvbnN0IGNvc3RPYmogPSBrZXlEb3duRXZ0LnRhcmdldCA9PT0gQ29zdE9iai5NSU4ucG9pbnRcbiAgICAgICAgPyBDb3N0T2JqLk1JTlxuICAgICAgICA6IENvc3RPYmouTUFYO1xuXG4gICAgICBpZiAoa2V5RG93bkV2dC5jb2RlID09PSBLZXlDb2RlLmxlZnQpIHtcbiAgICAgICAgY2hhbmdlUHJvcFZhbHVlKGNvc3RPYmosIGdldEN1cnJlbnRQcm9wVmFsdWUoY29zdE9iaikgLSAxKTtcbiAgICAgIH0gZWxzZSBpZiAoa2V5RG93bkV2dC5jb2RlID09PSBLZXlDb2RlLnJpZ2h0KSB7XG4gICAgICAgIGNoYW5nZVByb3BWYWx1ZShjb3N0T2JqLCBnZXRDdXJyZW50UHJvcFZhbHVlKGNvc3RPYmopICsgMSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIG1ha2VTeW5jaHJvbml6YXRpb24oQ29zdE9iai5NSU4sIENvc3RPYmouTUlOLmluaXRQcm9wVmFsdWUpO1xuICAgIG1ha2VTeW5jaHJvbml6YXRpb24oQ29zdE9iai5NQVgsIENvc3RPYmouTUFYLmluaXRQcm9wVmFsdWUpO1xuXG4gICAgbWluQ29zdC5hZGRFdmVudExpc3RlbmVyKGBpbnB1dGAsIG9uQ2hhbmdlQ29zdFZhbHVlKTtcbiAgICBtYXhDb3N0LmFkZEV2ZW50TGlzdGVuZXIoYGlucHV0YCwgb25DaGFuZ2VDb3N0VmFsdWUpO1xuXG4gICAgcG9pbnRNaW4uYWRkRXZlbnRMaXN0ZW5lcihgbW91c2Vkb3duYCwgb25Qb2ludE1vdXNlRG93bik7XG4gICAgcG9pbnRNYXguYWRkRXZlbnRMaXN0ZW5lcihgbW91c2Vkb3duYCwgb25Qb2ludE1vdXNlRG93bik7XG5cbiAgICBwb2ludE1pbi5hZGRFdmVudExpc3RlbmVyKGBrZXlkb3duYCwgb25Qb2ludEtleURvd24pO1xuICAgIHBvaW50TWF4LmFkZEV2ZW50TGlzdGVuZXIoYGtleWRvd25gLCBvblBvaW50S2V5RG93bik7XG5cbiAgICBwcmV2RWxlbWVudC5hZnRlcihyYW5nZUJsb2NrKTtcbiAgfVxufSkoKTtcbiIsIid1c2Ugc3RyaWN0JztcblxuKCgpID0+IHtcbiAgY29uc3QgT1BFTkVEX0NMQVNTID0gYHBvcHVwLS1vcGVuZWRgO1xuICBjb25zdCBOT19KU19DTEFTUyA9IGBwb3B1cC0tbm8tanNgO1xuICBjb25zdCBFUlJPUl9DTEFTUyA9IGBwb3B1cC0tZXJyb3JgO1xuICBjb25zdCBFUlJPUl9NRVNTQUdFID0gYNCe0LHRj9C30LDRgtC10LvRjNC90L7QtSDQv9C+0LvQtSDQtNC70Y8g0LfQsNC/0L7Qu9C90LXQvdC40Y9gO1xuICBjb25zdCBVUkwgPSBgaHR0cHM6Ly9lY2hvLmh0bWxhY2FkZW15LnJ1L2A7XG5cbiAgY29uc3Qgb3BlblBvcHVwQnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgI3BsYWNlbWVudF9fZGVzY3JpcHRpb24tYnV0dG9uLWpzYCk7XG4gIGNvbnN0IHBvcHVwID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgI3BvcHVwLWpzYCk7XG4gIGNvbnN0IHBvcHVwRm9ybSA9IHBvcHVwLnF1ZXJ5U2VsZWN0b3IoYCNwb3B1cF9fZm9ybS1qc2ApO1xuICBjb25zdCBjbG9zZVBvcHVwQnRuID0gcG9wdXAucXVlcnlTZWxlY3RvcihgI3BvcHVwX19jbG9zZS1idXR0b24tanNgKTtcbiAgY29uc3Qgc3VibWl0UG9wdXBGb3JtQnRuID0gcG9wdXAucXVlcnlTZWxlY3RvcihgI3BvcHVwX19zdWJtaXQtanNgKTtcbiAgY29uc3QgbmFtZUlucHV0ID0gcG9wdXAucXVlcnlTZWxlY3RvcihgI3BvcHVwLWZpZWxkLW5hbWUtanNgKTtcbiAgY29uc3QgZW1haWxJbnB1dCA9IHBvcHVwLnF1ZXJ5U2VsZWN0b3IoYCNwb3B1cC1maWVsZC1lbWFpbC1qc2ApO1xuICBjb25zdCBsZXR0ZXJUZXh0YXJlYSA9IHBvcHVwLnF1ZXJ5U2VsZWN0b3IoYCNwb3B1cC1maWVsZC1sZXR0ZXItanNgKTtcblxuICBjb25zdCBMb2NhbFN0b3JhZ2VLZXkgPSB7XG4gICAgTkFNRTogYHVzZXJOYW1lYCxcbiAgICBFTUFJTDogYHVzZXJFbWFpbGAsXG4gIH07XG5cbiAgY29uc3Qgb25Fc2NLZXlEb3duID0gKGV2dCkgPT4ge1xuICAgIGlmIChldnQuY29kZSA9PT0gYEVzY2FwZWApIHtcbiAgICAgIGNsb3NlUG9wdXAoKTtcbiAgICB9XG4gIH07XG5cbiAgY29uc3Qgb3BlblBvcHVwID0gKGV2dCkgPT4ge1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgcG9wdXAuY2xhc3NMaXN0LmFkZChPUEVORURfQ0xBU1MpO1xuXG4gICAgbmFtZUlucHV0LnZhbHVlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oTG9jYWxTdG9yYWdlS2V5Lk5BTUUpO1xuICAgIGVtYWlsSW5wdXQudmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShMb2NhbFN0b3JhZ2VLZXkuRU1BSUwpO1xuXG4gICAgY2xvc2VQb3B1cEJ0bi5hZGRFdmVudExpc3RlbmVyKGBjbGlja2AsIGNsb3NlUG9wdXApO1xuICAgIHN1Ym1pdFBvcHVwRm9ybUJ0bi5hZGRFdmVudExpc3RlbmVyKGBjbGlja2AsIHN1Ym1pdEZvcm0pO1xuICAgIG5hbWVJbnB1dC5hZGRFdmVudExpc3RlbmVyKGBpbnB1dGAsIG9uRmllbGREYXRhQ2hhbmdlZCk7XG4gICAgZW1haWxJbnB1dC5hZGRFdmVudExpc3RlbmVyKGBpbnB1dGAsIG9uRmllbGREYXRhQ2hhbmdlZCk7XG4gICAgbGV0dGVyVGV4dGFyZWEuYWRkRXZlbnRMaXN0ZW5lcihgaW5wdXRgLCBvbkZpZWxkRGF0YUNoYW5nZWQpO1xuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoYGtleWRvd25gLCBvbkVzY0tleURvd24pO1xuXG4gICAgbmFtZUlucHV0LmZvY3VzKCk7XG4gIH07XG5cbiAgY29uc3QgY2xvc2VQb3B1cCA9IChldnQpID0+IHtcbiAgICBpZiAoZXZ0KSB7XG4gICAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICB9XG5cbiAgICBwb3B1cC5jbGFzc0xpc3QucmVtb3ZlKE9QRU5FRF9DTEFTUyk7XG4gICAgcG9wdXAuY2xhc3NMaXN0LnJlbW92ZShFUlJPUl9DTEFTUyk7XG5cbiAgICBjbG9zZVBvcHVwQnRuLnJlbW92ZUV2ZW50TGlzdGVuZXIoYGNsaWNrYCwgY2xvc2VQb3B1cCk7XG4gICAgc3VibWl0UG9wdXBGb3JtQnRuLnJlbW92ZUV2ZW50TGlzdGVuZXIoYGNsaWNrYCwgc3VibWl0Rm9ybSk7XG4gICAgbmFtZUlucHV0LnJlbW92ZUV2ZW50TGlzdGVuZXIoYGlucHV0YCwgb25GaWVsZERhdGFDaGFuZ2VkKTtcbiAgICBlbWFpbElucHV0LnJlbW92ZUV2ZW50TGlzdGVuZXIoYGlucHV0YCwgb25GaWVsZERhdGFDaGFuZ2VkKTtcbiAgICBsZXR0ZXJUZXh0YXJlYS5yZW1vdmVFdmVudExpc3RlbmVyKGBpbnB1dGAsIG9uRmllbGREYXRhQ2hhbmdlZCk7XG4gICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihga2V5ZG93bmAsIG9uRXNjS2V5RG93bik7XG5cbiAgICBvcGVuUG9wdXBCdG4uZm9jdXMoKTtcbiAgfTtcblxuICBjb25zdCBjbGVhclBvcHVwID0gKCkgPT4ge1xuICAgIG5hbWVJbnB1dC52YWx1ZSA9IGBgO1xuICAgIGVtYWlsSW5wdXQudmFsdWUgPSBgYDtcbiAgICBsZXR0ZXJUZXh0YXJlYS52YWx1ZSA9IGBgO1xuICB9O1xuXG4gIGNvbnN0IHN1Ym1pdEZvcm0gPSAoZXZ0KSA9PiB7XG4gICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICBwb3B1cC5jbGFzc0xpc3QucmVtb3ZlKEVSUk9SX0NMQVNTKTtcblxuICAgIGlmIChpc1ZhbGlkRm9ybURhdGEoKSkge1xuICAgICAgZmV0Y2goVVJMLCB7XG4gICAgICAgIG1ldGhvZDogYFBPU1RgLFxuICAgICAgICBib2R5OiBuZXcgRm9ybURhdGEocG9wdXBGb3JtKSxcbiAgICAgIH0pXG4gICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgIHBvcHVwLmNsYXNzTGlzdC5hZGQoRVJST1JfQ0xBU1MpO1xuXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYF8ke3Jlc3BvbnNlLnN0YXR1c306ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShMb2NhbFN0b3JhZ2VLZXkuTkFNRSwgbmFtZUlucHV0LnZhbHVlKTtcbiAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShMb2NhbFN0b3JhZ2VLZXkuRU1BSUwsIGVtYWlsSW5wdXQudmFsdWUpO1xuXG4gICAgICAgICAgY2xlYXJQb3B1cCgpO1xuICAgICAgICAgIGNsb3NlUG9wdXAoKTtcblxuICAgICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgIHBvcHVwLmNsYXNzTGlzdC5hZGQoRVJST1JfQ0xBU1MpO1xuXG4gICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfTtcblxuICBjb25zdCBpc1ZhbGlkRmllbGQgPSAoZmllbGQpID0+IHtcbiAgICBpZiAoZmllbGQudmFsdWUubGVuZ3RoID4gMCkge1xuICAgICAgZmllbGQuc2V0Q3VzdG9tVmFsaWRpdHkoYGApO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBmaWVsZC5zZXRDdXN0b21WYWxpZGl0eShFUlJPUl9NRVNTQUdFKTtcblxuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcblxuICBjb25zdCBpc1ZhbGlkRm9ybURhdGEgPSAoKSA9PiB7XG4gICAgcmV0dXJuIGlzVmFsaWRGaWVsZChuYW1lSW5wdXQpXG4gICAgICAmJiBpc1ZhbGlkRmllbGQoZW1haWxJbnB1dClcbiAgICAgICYmIGlzVmFsaWRGaWVsZChsZXR0ZXJUZXh0YXJlYSk7XG4gIH07XG5cbiAgY29uc3Qgb25GaWVsZERhdGFDaGFuZ2VkID0gKGV2dCkgPT4ge1xuICAgIGlzVmFsaWRGaWVsZChldnQudGFyZ2V0KTtcbiAgfTtcblxuICBpZiAocG9wdXAgJiYgb3BlblBvcHVwQnRuICYmIGNsb3NlUG9wdXBCdG4gJiYgc3VibWl0UG9wdXBGb3JtQnRuKSB7XG4gICAgcG9wdXAuY2xhc3NMaXN0LnJlbW92ZShOT19KU19DTEFTUyk7XG4gICAgb3BlblBvcHVwQnRuLmFkZEV2ZW50TGlzdGVuZXIoYGNsaWNrYCwgb3BlblBvcHVwKTtcbiAgfVxufSkoKTtcbiIsIid1c2Ugc3RyaWN0JztcblxuKCgpID0+IHtcbiAgY29uc3Qgc2xpZGVyQ29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLnByaW5jaXBsZXNgKTtcblxuICBpZiAoc2xpZGVyQ29udGFpbmVyKSB7XG4gICAgY29uc3QgU0xJREVfQUNUSVZFX0NMQVNTID0gYHByaW5jaXBsZXNfX3NsaWRlLS1hY3RpdmVgO1xuICAgIGNvbnN0IEJVVFRPTl9BQ1RJVkVfQ0xBU1MgPSBgcHJpbmNpcGxlc19fY29udHJvbC1idXR0b24tLWFjdGl2ZWA7XG5cbiAgICBjb25zdCBjcmVhdGVFbGVtZW50ID0gKHRlbXBsYXRlKSA9PiB7XG4gICAgICBjb25zdCBuZXdFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChgZGl2YCk7XG4gICAgICBuZXdFbGVtZW50LmlubmVySFRNTCA9IHRlbXBsYXRlO1xuXG4gICAgICByZXR1cm4gbmV3RWxlbWVudC5maXJzdENoaWxkO1xuICAgIH07XG5cbiAgICBjb25zdCBjcmVhdGVTbGlkZXJCdXR0b24gPSAoc2xpZGUsIG51bWJlcikgPT4ge1xuICAgICAgY29uc3QgYnV0dG9uVGVtcGxhdGUgPSAoXG4gICAgICAgIGA8bGk+XG4gICAgICAgICAgPGJ1dHRvbiBjbGFzcz1cInByaW5jaXBsZXNfX2NvbnRyb2wtYnV0dG9uICAke251bWJlciA/IGBgIDogQlVUVE9OX0FDVElWRV9DTEFTU31cIiB0eXBlPVwiYnV0dG9uXCI+XG4gICAgICAgICAgICA8c3BhbiBjbGFzcz1cInZpc3VhbGx5LWhpZGRlblwiPtCf0YDQuNC90YbQuNC/ICR7bnVtYmVyICsgMX08L3NwYW4+XG4gICAgICAgICAgPC9idXR0b24+XG4gICAgICAgIDwvbGk+YFxuICAgICAgKTtcblxuICAgICAgY29uc3QgYnV0dG9uV3JhcHBlciA9IGNyZWF0ZUVsZW1lbnQoYnV0dG9uVGVtcGxhdGUpO1xuICAgICAgYnV0dG9uV3JhcHBlci5maXJzdEVsZW1lbnRDaGlsZC5hZGRFdmVudExpc3RlbmVyKGBjbGlja2AsIChldnQpID0+IHtcbiAgICAgICAgY29uc3QgY3VycmVudFNsaWRlID0gc2xpZGVyQ29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoYC4ke1NMSURFX0FDVElWRV9DTEFTU31gKTtcblxuICAgICAgICBpZiAoY3VycmVudFNsaWRlICE9PSBzbGlkZSkge1xuICAgICAgICAgIHNsaWRlckNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKGAuJHtCVVRUT05fQUNUSVZFX0NMQVNTfWApXG4gICAgICAgICAgICAuY2xhc3NMaXN0LnJlbW92ZShCVVRUT05fQUNUSVZFX0NMQVNTKTtcbiAgICAgICAgICBjdXJyZW50U2xpZGUuY2xhc3NMaXN0LnJlbW92ZShTTElERV9BQ1RJVkVfQ0xBU1MpO1xuXG4gICAgICAgICAgc2xpZGUuY2xhc3NMaXN0LmFkZChTTElERV9BQ1RJVkVfQ0xBU1MpO1xuICAgICAgICAgIGV2dC50YXJnZXQuY2xhc3NMaXN0LmFkZChCVVRUT05fQUNUSVZFX0NMQVNTKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGlmICghbnVtYmVyKSB7XG4gICAgICAgIHNsaWRlLmNsYXNzTGlzdC5hZGQoU0xJREVfQUNUSVZFX0NMQVNTKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGJ1dHRvbldyYXBwZXI7XG4gICAgfTtcblxuICAgIGNvbnN0IGJlZm9yZUluc2VydEJsb2NrID0gc2xpZGVyQ29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoYCNwcmluY2lwbGVzX19zbGlkZXItanNgKTtcbiAgICBjb25zdCBzbGlkZXMgPSBzbGlkZXJDb250YWluZXIucXVlcnlTZWxlY3RvckFsbChgLnByaW5jaXBsZXNfX3NsaWRlYCk7XG5cbiAgICBjb25zdCBidXR0b25zQ29udGFpbmVyID0gY3JlYXRlRWxlbWVudChgPHVsIGNsYXNzPVwicHJpbmNpcGxlc19fY29udHJvbCBsaXN0LXJlc2V0XCI+PC91bD5gKTtcblxuICAgIHNsaWRlcy5mb3JFYWNoKChzbGlkZSwgaW5kZXgpID0+IHtcbiAgICAgIHNsaWRlLmNsYXNzTGlzdC5yZW1vdmUoYHByaW5jaXBsZXNfX3NsaWRlLS1uby1qc2ApO1xuXG4gICAgICBidXR0b25zQ29udGFpbmVyLmFwcGVuZChjcmVhdGVTbGlkZXJCdXR0b24oc2xpZGUsIGluZGV4KSk7XG4gICAgfSk7XG5cblxuICAgIGJlZm9yZUluc2VydEJsb2NrLmFmdGVyKGJ1dHRvbnNDb250YWluZXIpO1xuICB9XG59KSgpO1xuIiwiJ3VzZSBzdHJpY3QnO1xuXG4oKCkgPT4ge1xuICBjb25zdCBBQ1RJVkVfU09SVF9UWVBFX0NMQVNTID0gYHNvcnQtcGFuZWxfX3R5cGUtLWFjdGl2ZWA7XG4gIGNvbnN0IEFDVElWRV9TT1JUX0RJUkVDVElPTl9DTEFTUyA9IGBzb3J0LXBhbmVsX19kaXJlY3Rpb24tLWFjdGl2ZWA7XG5cbiAgY29uc3Qgc29ydFR5cGVCdXR0b25zID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGAuc29ydC1wYW5lbF9fdHlwZWApKTtcbiAgY29uc3Qgc29ydERpcmVjdGlvbkJ1dHRvbnMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoYC5zb3J0LXBhbmVsX19kaXJlY3Rpb25gKSk7XG5cbiAgY29uc3Qgb25CdG5DbGljayA9IChldnQpID0+IHtcbiAgICBjb25zdCBzZWxlY3RlZEJ0biA9IGV2dC50YXJnZXQ7XG4gICAgbGV0IGFjdGl2ZUNsYXNzID0gYGA7XG4gICAgbGV0IGJ0bnMgPSBbXTtcblxuICAgIGlmIChzb3J0VHlwZUJ1dHRvbnMuaW5jbHVkZXMoc2VsZWN0ZWRCdG4pKSB7XG4gICAgICBhY3RpdmVDbGFzcyA9IEFDVElWRV9TT1JUX1RZUEVfQ0xBU1M7XG4gICAgICBidG5zID0gc29ydFR5cGVCdXR0b25zO1xuICAgIH0gZWxzZSB7XG4gICAgICBhY3RpdmVDbGFzcyA9IEFDVElWRV9TT1JUX0RJUkVDVElPTl9DTEFTUztcbiAgICAgIGJ0bnMgPSBzb3J0RGlyZWN0aW9uQnV0dG9ucztcbiAgICB9XG5cbiAgICBidG5zXG4gICAgICAuZmlsdGVyKChidG4pID0+IGJ0bi5jbGFzc0xpc3QuY29udGFpbnMoYWN0aXZlQ2xhc3MpKVxuICAgICAgLmZvckVhY2goKGJ0bikgPT4gYnRuLmNsYXNzTGlzdC5yZW1vdmUoYWN0aXZlQ2xhc3MpKTtcblxuICAgIHNlbGVjdGVkQnRuLmNsYXNzTGlzdC5hZGQoYWN0aXZlQ2xhc3MpO1xuICB9O1xuXG4gIHNvcnRUeXBlQnV0dG9ucy5mb3JFYWNoKChidG4pID0+IGJ0bi5hZGRFdmVudExpc3RlbmVyKGBjbGlja2AsIG9uQnRuQ2xpY2spKTtcbiAgc29ydERpcmVjdGlvbkJ1dHRvbnMuZm9yRWFjaCgoYnRuKSA9PiBidG4uYWRkRXZlbnRMaXN0ZW5lcihgY2xpY2tgLCBvbkJ0bkNsaWNrKSk7XG59KSgpO1xuIl19
